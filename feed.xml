<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.0.0">Jekyll</generator><link href="https://herman-wu.github.io/blogs/feed.xml" rel="self" type="application/atom+xml" /><link href="https://herman-wu.github.io/blogs/" rel="alternate" type="text/html" /><updated>2020-03-22T23:58:37-05:00</updated><id>https://herman-wu.github.io/blogs/feed.xml</id><title type="html">Herman’s Notebook</title><subtitle>Here is the repository of notes that I would like to remember and share</subtitle><entry><title type="html">Troubleshooting Azure Data Explorer (Kusto) cross-tenant access issues</title><link href="https://herman-wu.github.io/blogs/azure%20data%20explorer%20(kusto)/data/2020/03/17/TroubleShootingADXLoginIssues.html" rel="alternate" type="text/html" title="Troubleshooting  Azure Data Explorer (Kusto) cross-tenant access issues" /><published>2020-03-17T00:00:00-05:00</published><updated>2020-03-17T00:00:00-05:00</updated><id>https://herman-wu.github.io/blogs/azure%20data%20explorer%20(kusto)/data/2020/03/17/TroubleShootingADXLoginIssues</id><content type="html" xml:base="https://herman-wu.github.io/blogs/azure%20data%20explorer%20(kusto)/data/2020/03/17/TroubleShootingADXLoginIssues.html">&lt;h5 id=&quot;azure-data-explorer-introduction&quot;&gt;Azure Data Explorer Introduction&lt;/h5&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.microsoft.com/en-us/azure/data-explorer/data-explorer-overview&quot;&gt;Azure Data Explorer (ADX, aka Kusto)&lt;/a&gt; is a very powerfully log/historical data analysis platform provided by Microsoft that powers several key Azure services such as Application Insight, Azure Monitor, Time Series insight. It is designed to handle huge amounts of historical data and can ingest and process Peta-bytes of data every day with little efforts to set up the infrastructure. On February 7, 2019, Microsoft GA the service to customers.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://Herman-Wu.github.io/blogs/assets/img/2020-03-17-TroubleShootingADXLoginIssues/ADXOverview.jpg&quot; alt=&quot;img&quot; /&gt;&lt;/p&gt;

&lt;p&gt;One of the features that I particularly like is its query language KQL (Kusto Query Language), KQL combines the concept of SQL query and data pipeline. In real project experience, it is very powerful and saved me a lot of time to get the query result in the structure that my projects need. You can check &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/kusto/query/tutorial?pivots=azuredataexplorer&quot;&gt;this official tutorial&lt;/a&gt; that introduces KQL’s key concept and following is an example about how to query data 12 days ago and do count aggregation very 30 minutes. It’s a very popular bin count pattern when analyzing data on time dimension. In the query we use &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/kusto/query/mvexpandoperator&quot;&gt;“mv-expand”&lt;/a&gt; operator to make sure there is still a record presents the 0 count even the system has no data in that 30 minutes range. “mv-expand” is also very useful when you are parsing and expanding JSON data.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;let StartTime=ago(12d);
let StopTime=ago(11d);
T
| where Timestamp &amp;gt; StartTime and Timestamp &amp;lt;= StopTime 
| summarize Count=count() by bin(Timestamp, 30m)
| union ( // 1
  range x from 1 to 1 step 1 // 2
  | mv-expand Timestamp=range(StartTime, StopTime, 30m) to typeof(datetime) // 3
  | extend Count=0 // 4
  )
| summarize Count=sum(Count) by bin(Timestamp, 30m) // 5
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;https://Herman-Wu.github.io/blogs/assets/img/2020-03-17-TroubleShootingADXLoginIssues/kqlqueryresult.jpg&quot; alt=&quot;img&quot; /&gt;&lt;/p&gt;

&lt;p&gt;You can also easily generate a graphic chart to visualize your query result through &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/kusto/query/renderoperator?pivots=azuredataexplorer&quot;&gt;“render”&lt;/a&gt; operator. In the previous query, you can add “| render timechar” to generate the following graph which represents the trend of how many records we have every 30 mins eleven days ago.&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;|render timechart 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;https://Herman-Wu.github.io/blogs/assets/img/2020-03-17-TroubleShootingADXLoginIssues/kqlquerygraph.jpg&quot; alt=&quot;img&quot; /&gt;&lt;/p&gt;

&lt;p&gt;For data consumers ADX also provides various client tool that users can use to create different kind of query, graphic chart and dashboard. The tool that support ADX includes :&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.microsoft.com/en-us/azure/data-explorer/web-query-data&quot;&gt;ADX WebUI&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.microsoft.com/en-us/azure/kusto/tools/kusto-explorer&quot;&gt;Kusto Desktop Client tool&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;PowerBI&lt;/li&gt;
  &lt;li&gt;Excel&lt;/li&gt;
  &lt;li&gt;Jupyter Notebook(&lt;a href=&quot;https://github.com/microsoft/jupyter-Kqlmagic&quot;&gt;using KQLMagic extension&lt;/a&gt;)&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.microsoft.com/en-us/azure/data-explorer/grafana&quot;&gt;Grafana&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/Azure/azure-kusto-spark&quot;&gt;Spark&lt;/a&gt;   .&lt;/li&gt;
&lt;/ul&gt;

&lt;h5 id=&quot;azure-data-explorer-access-control&quot;&gt;Azure Data Explorer Access Control&lt;/h5&gt;

&lt;p&gt;In the access control part, ADX supports user authentication through Microsoft Accounts (MSAs) and Azure AD account. Microsoft Account is non-organizational user accounts, these accounts normally use email like hotmail.com, live.com, outlook.com. Azure AD account is created through Azure AD or another Microsoft cloud service such as Office 365. It will be tight to an Azure AD tenant and is the preferred method for authenticating to ADX.  Most enterprise users should use AAD account for authentication. Here has more information about &lt;a href=&quot;https://docs.microsoft.com/zh-tw/azure/kusto/management/access-control/&quot;&gt;ADX access control&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Like most Azure services, you can manage user accounts and their access to ADX through “Access control” function within Azure Portal.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://Herman-Wu.github.io/blogs/assets/img/2020-03-17-TroubleShootingADXLoginIssues/ADXAccessControl.jpg&quot; alt=&quot;img&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The other way to manage it is through KQL query. You can run the following command to check the accounts and roles that can access ADX database.&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;show&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;database&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;Database&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;principals&lt;/span&gt; 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can read ADX &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/kusto/management/security-roles&quot;&gt;Security roles management&lt;/a&gt; session to understand more about using  KQL to manage user access control.&lt;/p&gt;

&lt;p&gt;ADX authentication is also the part I would like to share a few troubleshooting tips which  I learned from projects.&lt;/p&gt;

&lt;h5 id=&quot;azuer-data-explorer-cross-tenant-access-issue&quot;&gt;Azuer Data Explorer cross-tenant access issue&lt;/h5&gt;

&lt;p&gt;Ideally if you login your PC with Azure AD account that in the same tenant of the Azure subscription which been used to create the ADX cluster, then everything should work good and you can just management user access in Azure Portal. However it’s not always the case, users can come from different organizations and partners. Here are a few ways we used to check and fix the issues.&lt;/p&gt;

&lt;h5 id=&quot;the-problem&quot;&gt;The problem:&lt;/h5&gt;
&lt;p&gt;&lt;em&gt;Grant a user to access ADX in Azure Portal UI. And the user can assess ADX in Azure portal. But he/she but couldn’t access it in &lt;a href=&quot;(https://docs.microsoft.com/en-us/azure/data-explorer/web-query-data)&quot;&gt;ADX Web UI&lt;/a&gt; and &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/kusto/tools/kusto-explorer&quot;&gt;Kusto Explorer&lt;/a&gt;, PowerBI, Excel or other client tools.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;What happened is when you grant a new user to access ADX, if the user’s account comes from a different tenant, in ADX it will create a new Principle Object Id in its tenant. If the user access ADX in Azure portal, the user’s account already switches to the right tenant so there is no problem accessing ADX. But if users from different tenant try to use other client tools, these client tools will use default tenant and which might not match the tenant that ADX is using.&lt;/p&gt;

&lt;h5 id=&quot;how-to-fix-the-issue&quot;&gt;How to fix the issue&lt;/h5&gt;

&lt;p&gt;&lt;em&gt;&lt;strong&gt;Solution A&lt;/strong&gt;: Force ADX WebUI and Kusto Explorer to use not ADX’s tenant&lt;/em&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;ADX WebUI&lt;/p&gt;

    &lt;p&gt;Default ADX WebUI has URL like&lt;/p&gt;

    &lt;p&gt;&lt;em&gt;https://dataexplorer.azure.com/clusters/[cluster name].[data center]&lt;/em&gt;&lt;/p&gt;

    &lt;p&gt;You can force it to recognize a user’s login tenant by add &amp;amp;tenant=[tenant id] to the URL. So it will look like&lt;/p&gt;

    &lt;p&gt;&lt;em&gt;https://dataexplorer.azure.com/clusters/[cluster name].[data center]?tenant=[tenant id]&lt;/em&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Kusto Explorer Client&lt;/p&gt;

    &lt;p&gt;Instead of default connection by specifying ADK cluster URL, You need to use advanced query.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://Herman-Wu.github.io/blogs/assets/img/2020-03-17-TroubleShootingADXLoginIssues/KustoExpConn.jpg&quot; alt=&quot;img&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The connection string will be like:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  Data Source=https://[Cluster Name].[Data Center].kusto.windows.net;AAD Federated Security=True;AAD User ID=[User's AAD account(E-mail)];Authority Id=[User's AAD account tenant ID ]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;&lt;strong&gt;Solution B&lt;/strong&gt;: Grant user using ‘right’ tenant id and account id&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;As said by default user granted in Azure portal will using ADX’s tenant id and create a new account object id. If you want to add a user from a different tenant, the suggested way will be to grant users using KQL.&lt;/p&gt;

&lt;p&gt;You can grant a new user with different roles like&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-kql&quot;&gt;.add database [Database Name] [Role Name]  ('aaduser=[User AAD account id];[User AAD tenant id]') 'Notes for the account, eg. User Name'

&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Get AAD account object id &amp;amp; tenant id using Azure CLI&lt;/p&gt;

    &lt;p&gt;To get user’s AAD account object id, you can use Azure CLI command :&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  az ad signed-in-user show 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To get the user’s tenant ID, you can use Azure CLI command :&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  az account list 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Get AAD account object id &amp;amp; tenant id in Azure portal&lt;/p&gt;

    &lt;p&gt;You can also find AAD account object id &amp;amp; tenant id in Azure Active Directory service of  Azure portal.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://Herman-Wu.github.io/blogs/assets/img/2020-03-17-TroubleShootingADXLoginIssues/AAD.jpg&quot; alt=&quot;img&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Get AAD account object id &amp;amp; tenant id in ADX Web UI&lt;/p&gt;

    &lt;p&gt;If you login using ADX Web UI, actually the error message contains the AAD user account id and tenant id. The message will be looks like following&lt;/p&gt;

    &lt;p&gt;&lt;em&gt;Error message : 
action Principal ‘aaduser=[&lt;strong&gt;AAD accound id&lt;/strong&gt;];[ &lt;strong&gt;AAD tenant id&lt;/strong&gt; ]’ is not authorized to perform operation&lt;/em&gt;&lt;/p&gt;

    &lt;p&gt;It’s another easy way to get the information you needed.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;br /&gt;
ADX is a very powerful platform that provides interactive analysis capabilities which can handle huge amount of historical log data with little infrastructure maintenance efforts. Because most enterprises use Azure AD to grant users access, helping these tips can save you sometime when you have cross tenant access requirements.&lt;/p&gt;</content><author><name></name></author><summary type="html">Azure Data Explorer Introduction</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://azurecomcdn.azureedge.net/cvt-ee71595d3667788def73479da1629d673313a0b081e460fc596839b82f34a2df/images/page/services/machine-learning/mlops/steps/mlops-slide1-step3.svg" /><media:content medium="image" url="https://azurecomcdn.azureedge.net/cvt-ee71595d3667788def73479da1629d673313a0b081e460fc596839b82f34a2df/images/page/services/machine-learning/mlops/steps/mlops-slide1-step3.svg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Test</title><link href="https://herman-wu.github.io/blogs/2019/03/03/Test.html" rel="alternate" type="text/html" title="Test" /><published>2019-03-03T00:00:00-06:00</published><updated>2019-03-03T00:00:00-06:00</updated><id>https://herman-wu.github.io/blogs/2019/03/03/Test</id><content type="html" xml:base="https://herman-wu.github.io/blogs/2019/03/03/Test.html">&lt;p&gt;Test Images&lt;/p&gt;

&lt;p&gt;This is a Test&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://Herman-Wu.github.io/blogs/assets/img/2019-03-03-Test/media/image1.jpeg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/Herman-Wu/blogs/blob/master/images/diagram.png?raw=true&quot;&gt;https://github.com/Herman-Wu/blogs/blob/master/images/diagram.png?raw=true&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;assets/img/2019-03-03-Test/media/image2.png&quot; alt=&quot;Screenshot&quot; /&gt;&lt;/p&gt;</content><author><name></name></author><summary type="html">Test Images</summary></entry></feed>